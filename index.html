<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English with AI Bayan 4grade II</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#002B5C">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="logo.png">

<style>
:root{
  --blue-dark:#002B5C;
  --blue-mid:#004C8F;
  --gold:#FFD54F;
  --gold-light:#FFEB99;
  --card-shadow:0 3px 10px rgba(0,0,0,0.3);
}
*{box-sizing:border-box;}
body{
  font-family:Verdana,sans-serif;
  margin:0;
  text-align:center;
  background:var(--blue-dark);
  color:#fff;
}
body.teacher-mode{
  background:linear-gradient(180deg,#fff3b0 0%,#ffe27f 100%);
}

/* –±–∞–Ω–Ω–µ—Ä —É—á–∏—Ç–µ–ª—è */
#teacherBanner{
  display:none;
  background:var(--gold);
  color:var(--blue-dark);
  padding:8px 10px;
  font-weight:bold;
  border-bottom:3px solid var(--blue-dark);
}
body.teacher-mode #teacherBanner{display:block;}

/* ====== –®–ê–ü–ö–ê –° –£–ó–û–†–û–ú ====== */
header{
  max-width:900px;
  margin:8px auto 0;
  padding:10px 10px 20px;
  border-radius:20px;
  border:3px solid var(--gold);
  box-shadow:0 6px 14px rgba(0,0,0,0.45);
  background:linear-gradient(180deg,#005499 0%,#002B5C 100%);
  position:relative;
  overflow:hidden;
}
header::before{
  content:"";
  position:absolute;
  top:0;
  left:-5%;
  width:110%;
  height:34px;
  background-image:
    repeating-linear-gradient(135deg,
      rgba(255,215,0,0.95) 0px,
      rgba(255,255,255,0.7) 4px,
      rgba(255,215,0,0.95) 8px,
      rgba(240,180,0,0.9) 12px);
  border-bottom:2px solid #fff9c4;
  box-shadow:0 3px 8px rgba(0,0,0,0.5);
}
.header-inner{position:relative;z-index:1;margin-top:30px;}
header h1{
  margin:0 0 4px;
  font-size:1.6rem;
  letter-spacing:0.05em;
  color:var(--gold-light);
  text-shadow:0 0 8px rgba(0,0,0,0.7);
}
header h2{
  margin:0;
  font-size:1rem;
  color:#EAF6FF;
  text-shadow:0 0 5px rgba(0,0,0,0.5);
}

/* ====== OVERLAY LOGIN ====== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.55);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.overlay-card{
  background:white;
  border:4px solid var(--gold);
  padding:20px;
  border-radius:16px;
  box-shadow:0 0 15px rgba(0,0,0,0.4);
  width:90%;
  max-width:380px;
  color:#002b5c;
}
.overlay-card h2{margin-top:0;}
.overlay-card input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  margin:6px 0;
  font-size:1rem;
}
.btn{
  background:var(--blue-mid);
  color:#fff;
  border:none;
  border-radius:10px;
  padding:8px 14px;
  font-weight:bold;
  cursor:pointer;
  margin:6px;
  transition:0.2s;
  font-size:0.9rem;
}
.btn:hover{background:var(--gold);color:var(--blue-dark);}

/* ====== MAIN ====== */
main{padding:0.8rem 0.5rem 4.5rem;}

/* –±–ª–æ–∫ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è */
#welcomeBox{
  display:none;
  background:rgba(255,255,255,0.08);
  border:2px solid var(--gold);
  border-radius:12px;
  max-width:900px;
  margin:12px auto 8px;
  padding:8px 10px;
  color:var(--gold-light);
  box-shadow:var(--card-shadow);
}
#welcomeBox h2{margin:4px 0;}

/* —Å–µ—Ç–∫–∞ —Ç–µ–º */
.topics-grid{
  max-width:900px;
  margin:8px auto 6px;
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:10px;
}
.topic-btn{
  background:rgba(255,255,255,0.08);
  border:2px solid var(--gold);
  border-radius:14px;
  padding:10px 8px;
  font-size:0.95rem;
  font-weight:bold;
  color:var(--gold-light);
  cursor:pointer;
  box-shadow:0 3px 10px rgba(0,0,0,0.3);
  transition:0.2s transform,0.2s box-shadow,0.2s background,0.2s color;
}
.topic-btn:hover{
  background:var(--gold);
  color:var(--blue-dark);
  transform:translateY(-2px);
  box-shadow:0 5px 14px rgba(0,0,0,0.5);
}

/* CHAT & JOURNAL */
#chatSection,#teacherJournal{
  max-width:900px;
  margin:12px auto;
  display:none;
}
#chatBox{
  background:#fff;
  border:2px solid var(--gold);
  border-radius:10px;
  padding:10px;
  max-height:300px;
  overflow-y:auto;
  text-align:left;
  color:#002b5c;
}
textarea{
  width:90%;
  border-radius:8px;
  border:1px solid #ccc;
  padding:6px;
  font-family:inherit;
  min-height:60px;
}
table{border-collapse:collapse;margin:auto;font-size:0.85rem;background:white;color:#002b5c;}
th,td{border:1px solid #ccc;padding:5px 8px;}
th{background:var(--blue-mid);color:white;}

/* –∫–Ω–æ–ø–∫–∞ Install */
.install-btn{
  position:fixed;
  bottom:14px;
  left:50%;
  transform:translateX(-50%);
  background:var(--gold);
  color:var(--blue-dark);
  border:none;
  border-radius:50%;
  width:64px;
  height:64px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  font-size:0.75rem;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
  cursor:pointer;
  z-index:1000;
}
.install-btn .icon{font-size:1.3rem;margin-bottom:2px;}
.install-btn:hover{background:#ffec8b;}

@media(max-width:700px){
  header{margin:6px 8px 0;}
  .topics-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
}
</style>
</head>

<body>
<div id="teacherBanner">üë©‚Äçüè´ TEACHER MODE ACTIVE ‚Äî unlimited questions</div>

<!-- ====== LOGIN OVERLAY ====== -->
<div class="overlay" id="loginOverlay">
  <div class="overlay-card">
    <h2>English with AI Bayan 4grade II</h2>
    <p style="font-size:0.9rem;">Enter your name and PIN:</p>
    <input type="text" id="nameInput" placeholder="Name">
    <input type="password" id="pinInput" placeholder="PIN" maxlength="4">
    <button class="btn" onclick="checkLogin()">Enter</button>
  </div>
</div>

<header>
  <div class="header-inner">
    <h1>ENGLISH WITH AI BAYAN</h1>
    <h2>4 GRADE II</h2>
  </div>
</header>

<main>
  <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
  <div id="mainMenu" style="display:none;">
    <div class="topics-grid">
      <button class="topic-btn" onclick="openTheme(1)">1. Let‚Äôs Have Fun!</button>
      <button class="topic-btn" onclick="openTheme(2)">2. Sports and Exercises</button>
      <button class="topic-btn" onclick="openTheme(3)">3. Sports Around the World</button>
      <button class="topic-btn" onclick="openTheme(4)">4. Arts and Music</button>
      <button class="topic-btn" onclick="openTheme(5)">5. Popular Team Sports</button>
      <button class="topic-btn" onclick="openTheme(6)">6. Museum of Kazakh Musical Instruments</button>
      <button class="topic-btn" onclick="openTheme(7)">7. Children‚Äôs Rights & Responsibilities</button>
      <button class="topic-btn" onclick="openTheme(8)">8. Different Jobs</button>
      <button class="topic-btn" onclick="openTheme(9)">9. Professions</button>
      <button class="topic-btn" onclick="openTheme(10)">10. People at Work</button>
      <button class="topic-btn" onclick="openTheme(11)">11. What Do You Do?</button>
      <button class="topic-btn" onclick="openTheme(12)">12. You Can Help!</button>
      <button class="topic-btn" onclick="openTheme(13)">13. Final Challenge</button>
      <button class="topic-btn" onclick="openChat()">üí¨ AI Bayan Chat</button>
      <button class="topic-btn" onclick="openTeacherJournal()">üè´ Teacher‚Äôs Journal</button>
    </div>

    <div id="welcomeBox">
      <h2 id="welcomeText">Hello!</h2>
      <p>Total stars in all lessons: <b><span id="totalStars">0</span> ‚≠ê</b></p>
    </div>
  </div>

  <!-- –ß–ê–¢ -->
  <div id="chatSection">
    <h2>üí¨ AI Bayan ‚Äî Chat</h2>
    <div id="chatBox"></div>
    <textarea id="chatInput" placeholder="Type your message..."></textarea><br>
    <button class="btn" onclick="askBayan()">Ask AI Bayan</button>
    <button class="btn" onclick="clearChat()">Clear</button>
    <button class="btn" onclick="backMenu()">üè† Menu</button>
    <p id="limitCounter" style="font-weight:bold;">‚≠ê 3 of 3 questions left today</p>
  </div>

  <!-- –ñ–£–†–ù–ê–õ -->
  <div id="teacherJournal">
    <h2>üè´ Teacher Journal</h2>
    <table>
      <thead>
        <tr><th>Student</th><th>L1‚ÄìL13</th><th>Chat</th><th>Total ‚≠ê</th></tr>
      </thead>
      <tbody id="journalBody"></tbody>
    </table>
    <button class="btn" onclick="backMenu()">üè† Menu</button>
  </div>
</main>

<button class="install-btn" id="installButton">
  <span class="icon">‚¨áÔ∏è</span>
  <span>Install</span>
</button>

<script>
/* ===== INSTALL PWA ===== */
let deferredPrompt;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;});
document.getElementById('installButton').addEventListener('click',async()=>{
  if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}
  else alert("To install, open browser menu ‚Üí Add to Home screen.");
});

/* ===== –°–¢–£–î–ï–ù–¢–´ ===== */
const allowedNames=[
  "Aytach2","Aylin2","Alvi2","Zhahangir2","Narmin2","Balman2",
  "Ilyas2","Dmitry2","Irada2","Shyngys2","Kiril2","Sultan2",
  "Kira2","Allahverdy2","Aziza2","Emir2","Monya2","Aeka2",
  "Bayan2","Arai2","Jury2","Jury1","Meyirim2"
];

const WORKER_URL="https://shiny-tree-f78c.aiko030500.workers.dev";
let DAILY_LIMIT=3;
let usedToday=Number(localStorage.getItem("usedToday"))||0;
let lastDate=localStorage.getItem("lastDate");
let today=new Date().toDateString();
let isTeacher=localStorage.getItem("isTeacher")==="true";

if(lastDate!==today){
  usedToday=0;
  localStorage.setItem("lastDate",today);
  localStorage.setItem("usedToday",0);
}

function updateCounter(){
  const c=document.getElementById("limitCounter");
  if(!c)return;
  c.innerHTML=isTeacher
    ?"üë©‚Äçüè´ Teacher mode: unlimited questions"
    :`‚≠ê ${DAILY_LIMIT-usedToday} of ${DAILY_LIMIT} questions left today`;
}

/* ===== LOGIN ===== */
function checkLogin(){
  const n=document.getElementById("nameInput").value.trim().toLowerCase();
  const p=document.getElementById("pinInput").value.trim();
  const a=allowedNames.map(x=>x.toLowerCase());

  if(a.includes(n)&&p==="6856"){
    localStorage.setItem("currentStudent",n);
    localStorage.removeItem("isTeacher");
    document.getElementById("loginOverlay").style.display="none";
    document.getElementById("mainMenu").style.display="block";
    document.getElementById("chatSection").style.display="none";
    document.getElementById("teacherJournal").style.display="none";
    document.getElementById("welcomeBox").style.display="block";
    document.getElementById("welcomeText").innerText="Hello, "+n+"!";
    updateCounter();
  }else if(n==="teacher"&&p==="1402"){
    localStorage.setItem("isTeacher","true");
    isTeacher=true;
    document.body.classList.add("teacher-mode");
    document.getElementById("teacherBanner").style.display="block";
    document.getElementById("loginOverlay").style.display="none";
    document.getElementById("mainMenu").style.display="block";
    document.getElementById("chatSection").style.display="none";
    document.getElementById("teacherJournal").style.display="none";
    document.getElementById("welcomeBox").style.display="block";
    document.getElementById("welcomeText").innerText="Hello, teacher!";
    updateCounter();
  }else{
    alert("‚ùå Wrong name or PIN");
  }
}

/* ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø –í–ù–£–¢–†–ò INDEX ===== */
function openTheme(n){window.location.href="theme"+n+".html";}
function openChat(){
  document.getElementById("mainMenu").style.display="none";
  document.getElementById("chatSection").style.display="block";
  document.getElementById("teacherJournal").style.display="none";
  updateCounter();
}
function openTeacherJournal(){
  document.getElementById("mainMenu").style.display="none";
  document.getElementById("chatSection").style.display="none";
  document.getElementById("teacherJournal").style.display="block";
  buildJournal();
}
function backMenu(){
  document.getElementById("chatSection").style.display="none";
  document.getElementById("teacherJournal").style.display="none";
  document.getElementById("mainMenu").style.display="block";
}

/* ===== –ñ–£–†–ù–ê–õ ===== */
function buildJournal(){
  const b=document.getElementById("journalBody");
  b.innerHTML="";
  allowedNames.forEach(n=>{
    let lessonsStars=0;
    for(let i=1;i<=13;i++){
      lessonsStars+=Number(localStorage.getItem(n+"_lesson"+i+"Stars"))||0;
    }
    const chatStars=Number(localStorage.getItem(n+"_chatStars"))||0;
    const total=lessonsStars+chatStars;
    b.innerHTML+=`<tr>
      <td>${n}</td>
      <td>${lessonsStars}</td>
      <td>${chatStars}</td>
      <td>${total}</td>
    </tr>`;
  });
}

/* ===== –ì–û–õ–û–° –ë–∞—è–Ω ===== */
function bayanSpeak(text){
  if(!("speechSynthesis"in window))return;
  const talk=()=>{
    const voices=speechSynthesis.getVoices();
    let voice=voices.find(v=>v.name.includes("Google UK English Female")||v.lang==="en-GB");
    if(!voice)voice=voices[0];
    const u=new SpeechSynthesisUtterance(text);
    u.voice=voice;u.lang="en-GB";u.rate=0.9;u.pitch=1.1;u.volume=1;
    speechSynthesis.speak(u);
  };
  if(speechSynthesis.getVoices().length===0){
    speechSynthesis.onvoiceschanged=talk;
  }else talk();
}

/* ===== –ß–ê–¢ ===== */
async function askBayan(){
  const input=document.getElementById("chatInput");
  const box=document.getElementById("chatBox");
  const q=input.value.trim();
  if(!q){alert("Type your question first!");return;}

  if(!isTeacher&&usedToday>=DAILY_LIMIT){
    alert("‚ö†Ô∏è Daily limit reached.");return;
  }

  box.innerHTML+=`<p><b>You:</b> ${q}</p>`;
  input.value="";
  box.innerHTML+=`<p><i>AI Bayan is thinking...</i></p>`;
  box.scrollTop=box.scrollHeight;

  try{
    const r=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({messages:[{role:"user",content:q}]})
    });
    const d=await r.json();
    const reply=d.reply||"Sorry, I can‚Äôt answer now.";
    box.innerHTML+=`<p><b>AI Bayan:</b> ${reply}</p>`;
    bayanSpeak(reply);
    if(!isTeacher){
      usedToday++;
      localStorage.setItem("usedToday",usedToday);
      updateCounter();
    }
  }catch(e){
    box.innerHTML+=`<p><b>AI Bayan:</b> ‚ùå Connection error.</p>`;
  }
}
function clearChat(){document.getElementById("chatBox").innerHTML="";}

/* ===== SERVICE WORKER ===== */
if("serviceWorker"in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("sw.js")
      .catch(err=>console.log("SW registration failed:",err));
  });
}

/* INIT */
updateCounter();
</script>

</body>
</html>
