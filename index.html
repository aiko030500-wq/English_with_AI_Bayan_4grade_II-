<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English with AI Bayan 4grade II</title>

<!-- üåü PWA + —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–≤ —Ç.—á. –Ω–∞ –¢–í) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003366">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="AI Bayan 4grade II">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="logo.png">

<style>
  body {
    font-family: Verdana, sans-serif;
    margin: 0;
    text-align: center;
    color: #002b5c;
    background: #e3f2fd url("ornament-bg.png") center/cover fixed no-repeat;
    transition: background 0.6s;
  }
  body.teacher-mode {
    background: linear-gradient(180deg,#fff3b0 0%,#ffe27f 100%);
  }

  header {
   <header>
  <div class="header-left">
    <img src="logo.png" alt="AI Bayan" class="logo-circle">
    <div class="header-title">
      <h1>English with AI Bayan 4 grade II</h1>
      <p>Fun English with AI Teacher Bayan</p>
    </div>
  </div>
  <div class="header-right">
    <img src="girl.png" alt="Kazakh girl" class="girl-circle">
  </div>
</header> 

  .header-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid gold;
    object-fit: cover;
    background: #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
  }
  .header-title h1 {
    margin: 0;
    font-size: 1.1rem;
  }
  .header-title p {
    margin: 2px 0 0;
    font-size: 0.85rem;
    color: #ffecb3;
  }
  body.teacher-mode .header-title p {
    color: #003366;
  }

  #teacherBanner {
    display: none;
    background: gold;
    color: #003366;
    padding: 10px;
    font-weight: bold;
    border-bottom: 3px solid #003366;
  }
  body.teacher-mode #teacherBanner {
    display: block;
  }

  main {
    padding: 1rem;
  }

  .btn {
    background:#003366;
    color:#fff;
    border:none;
    border-radius:10px;
    padding:8px 14px;
    font-weight:bold;
    cursor:pointer;
    margin:6px;
    transition:0.3s;
    font-size:0.9rem;
  }
  .btn:hover {
    background:gold;
    color:#003366;
  }

  .overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:999;
  }
  .overlay-card {
    background:white;
    border:4px solid gold;
    padding:20px;
    border-radius:16px;
    box-shadow:0 0 15px rgba(0,0,0,0.3);
    width:90%;
    max-width:380px;
    text-align:center;
  }
  .overlay-card input {
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    margin:6px 0;
    font-size:1rem;
  }

  #welcomeBox {
    background:rgba(255,255,255,0.9);
    border-radius:16px;
    padding:10px 16px;
    max-width:500px;
    margin:10px auto 5px;
    border:2px solid gold;
  }
  #welcomeBox h2 {
    margin:4px 0;
    font-size:1.1rem;
  }
  #welcomeBox p {
    margin:4px 0;
    font-size:0.9rem;
  }

  .grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:10px;
    max-width:900px;
    margin:10px auto 20px;
  }
  .card {
    background:white;
    border:2px solid #dde6ff;
    border-radius:16px;
    padding:14px;
    cursor:pointer;
    box-shadow:0 0 10px rgba(0,0,0,0.05);
    font-size:0.9rem;
  }
  .card:hover {
    border-color:gold;
    transform:translateY(-2px);
  }

  #chatBox {
    background:#fff;
    border:2px solid gold;
    border-radius:10px;
    padding:10px;
    max-height:300px;
    overflow-y:auto;
    text-align:left;
  }
  textarea {
    width:90%;
    border-radius:8px;
    border:1px solid #ccc;
    padding:6px;
    font-family:inherit;
    min-height:60px;
  }

  table {
    border-collapse:collapse;
    margin:auto;
    font-size:0.85rem;
  }
  th, td {
    border:1px solid #ccc;
    padding:5px 8px;
  }
  th {
    background:#003366;
    color:white;
  }
</style>
</head>

<body>

<div id="teacherBanner">üë©‚Äçüè´ TEACHER MODE ACTIVE ‚Äî unlimited questions</div>

<!-- üîê LOGIN -->
<div class="overlay" id="loginOverlay">
  <div class="overlay-card">
    <h2>English with AI Bayan 4grade II</h2>
    <p style="font-size:0.9rem;">Enter your name and PIN:</p>
    <input type="text" id="nameInput" placeholder="Name">
    <input type="password" id="pinInput" placeholder="PIN" maxlength="4">
    <button class="btn" onclick="checkLogin()">Enter</button>
  </div>
</div>

<header>
  <div class="header-left">
    <!-- ‚ö†Ô∏è —Å—é–¥–∞ –ø–æ–ª–æ–∂–∏ —Ñ–∞–π–ª logo.png ‚Äî –∫—Ä—É–≥–ª—ã–π –ª–æ–≥–æ—Ç–∏–ø -->
    <img src="logo.png" alt="AI Bayan" class="logo-circle">
    <div class="header-title">
      <h1>English with AI Bayan 4grade II</h1>
      <p>Fun English with AI Teacher Bayan</p>
    </div>
  </div>
</header>

<main>

  <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∑–≤—ë–∑–¥—ã -->
  <div id="welcomeBox" style="display:none;">
    <h2 id="welcomeText">Hello!</h2>
    <p>Total stars in all lessons: <b><span id="totalStars">0</span> ‚≠ê</b></p>
  </div>

  <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="mainMenu" style="display:none;">
    <div class="grid">
      <div class="card" onclick="openTheme(1)">1. üé® Let‚Äôs Have Fun!</div>
      <div class="card" onclick="openTheme(2)">2. üèÉ Sports and Exercises</div>
      <div class="card" onclick="openTheme(3)">3. üåç Sports Around the World</div>
      <div class="card" onclick="openTheme(4)">4. üéµ Arts and Music</div>
      <div class="card" onclick="openTheme(5)">5. ‚öΩ Popular Team Sports</div>
      <div class="card" onclick="openTheme(6)">6. üéª Museum of Kazakh Musical Instruments</div>
      <div class="card" onclick="openTheme(7)">7. üìú Children‚Äôs Rights & Responsibilities</div>
      <div class="card" onclick="openTheme(8)">8. üß∞ Different Jobs</div>
      <div class="card" onclick="openTheme(9)">9. üë©‚Äç‚öïÔ∏è Professions</div>
      <div class="card" onclick="openTheme(10)">10. üè¢ People at Work</div>
      <div class="card" onclick="openTheme(11)">11. üí¨ What Do You Do?</div>
      <div class="card" onclick="openTheme(12)">12. ‚ù§Ô∏è You Can Help!</div>
      <div class="card" onclick="openTheme(13)">13. üéØ Final Challenge</div>
      <div class="card" onclick="openChat()">üí¨ AI Bayan Chat</div>
      <div class="card" onclick="openTeacherJournal()">üè´ Teacher Journal</div>
    </div>
  </div>

  <!-- üí¨ AI Bayan Chat -->
  <div id="chatSection" style="display:none;">
    <h2>üí¨ AI Bayan ‚Äî Chat</h2>
    <div id="chatBox"></div>
    <textarea id="chatInput" placeholder="Type your message..."></textarea><br>
    <button class="btn" onclick="askBayan()">Ask AI Bayan</button>
    <button class="btn" onclick="clearChat()">Clear</button>
    <button class="btn" onclick="backMenu()">üè† Menu</button>
    <p id="limitCounter" style="font-weight:bold;color:#003366;">‚≠ê 3 of 3 questions left today</p>
  </div>

  <!-- üè´ Teacher Journal -->
  <div id="teacherJournal" style="display:none;">
    <h2>üè´ Teacher Journal</h2>
    <table>
      <thead>
        <tr>
          <th>Student</th>
          <th>L1‚ÄìL13</th>
          <th>Chat</th>
          <th>Total ‚≠ê</th>
        </tr>
      </thead>
      <tbody id="journalBody"></tbody>
    </table>
    <button class="btn" onclick="backMenu()">üè† Menu</button>
  </div>
</main>

<script>
const allowedNames = [
  "Aytach2","Aylin2","Alvi2","Zhahangir2","Narmin2","Balman2","Ilyas2",
  "Dmitry2","Irada2","Shyngys2","Kiril2","Sultan2","Kira2","Allahverdy2",
  "Aziza2","Emir2","Monya2","Aeka2","Bayan2","Arai2","Jury2","Jury1","Meyirim2"
];

const WORKER_URL = "https://shiny-tree-f78c.aiko030500.workers.dev";

let DAILY_LIMIT = 3;
let usedToday = Number(localStorage.getItem("usedToday")) || 0;
let lastDate = localStorage.getItem("lastDate");
const today = new Date().toDateString();
let isTeacher = localStorage.getItem("isTeacher") === "true";

if (lastDate !== today) {
  usedToday = 0;
  localStorage.setItem("lastDate", today);
  localStorage.setItem("usedToday", 0);
}

// –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –ª–∏–º–∏—Ç–∞ —á–∞—Ç–∞
function updateCounter() {
  const c = document.getElementById("limitCounter");
  if (!c) return;
  c.innerHTML = isTeacher
    ? "üë©‚Äçüè´ Teacher mode: unlimited questions"
    : `‚≠ê ${DAILY_LIMIT - usedToday} of ${DAILY_LIMIT} questions left today`;
}

// –ø–µ—Ä–µ—Å—á—ë—Ç –æ–±—â–∏—Ö –∑–≤—ë–∑–¥ (–ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ —Ç–µ–º)
function updateTotalStarsBox() {
  const name = localStorage.getItem("currentStudent");
  if (!name) return;
  let total = 0;
  for (let i = 1; i <= 13; i++) {
    total += Number(localStorage.getItem(name + "_lesson" + i + "Stars")) || 0;
  }
  const chatStars = Number(localStorage.getItem(name + "_chatStars")) || 0;
  total += chatStars;
  document.getElementById("totalStars").innerText = total;
}

// –≤—Ö–æ–¥
function checkLogin() {
  const rawName = document.getElementById("nameInput").value.trim();
  const name = rawName.toLowerCase();
  const pin  = document.getElementById("pinInput").value.trim();
  const allowedLower = allowedNames.map(x => x.toLowerCase());

  // —Å—Ç—É–¥–µ–Ω—Ç
  if (allowedLower.includes(name) && pin === "6856") {
    localStorage.setItem("currentStudent", rawName);
    localStorage.removeItem("isTeacher");
    isTeacher = false;

    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainMenu").style.display = "block";
    document.getElementById("welcomeBox").style.display = "block";
    document.getElementById("welcomeText").innerText = "Hello, " + rawName + "!";
    updateTotalStarsBox();
    updateCounter();
  }
  // —É—á–∏—Ç–µ–ª—å
  else if (name === "teacher" && pin === "1402") {
    localStorage.setItem("isTeacher", "true");
    isTeacher = true;

    document.body.classList.add("teacher-mode");
    document.getElementById("teacherBanner").style.display = "block";
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("mainMenu").style.display = "block";
    document.getElementById("welcomeBox").style.display = "none";

    updateCounter();
  }
  else {
    alert("‚ùå Wrong name or PIN");
  }
}

function openTheme(n) {
  window.location.href = "theme" + n + ".html";
}

function openChat() {
  document.getElementById("mainMenu").style.display = "none";
  document.getElementById("teacherJournal").style.display = "none";
  document.getElementById("chatSection").style.display = "block";
  updateCounter();
}

function openTeacherJournal() {
  document.getElementById("mainMenu").style.display = "none";
  document.getElementById("chatSection").style.display = "none";
  document.getElementById("teacherJournal").style.display = "block";
  buildJournal();
}

function backMenu() {
  document.getElementById("teacherJournal").style.display = "none";
  document.getElementById("chatSection").style.display = "none";
  document.getElementById("mainMenu").style.display = "block";
}

// –∑–∞–ø–æ–ª–Ω—è–µ–º –∂—É—Ä–Ω–∞–ª
function buildJournal() {
  const body = document.getElementById("journalBody");
  body.innerHTML = "";
  allowedNames.forEach(name => {
    let total = 0;
    for (let i = 1; i <= 13; i++) {
      total += Number(localStorage.getItem(name + "_lesson" + i + "Stars")) || 0;
    }
    const chat = Number(localStorage.getItem(name + "_chatStars")) || 0;
    total += chat;
    body.innerHTML += `<tr>
      <td>${name}</td>
      <td>${total - chat}</td>
      <td>${chat}</td>
      <td>${total}</td>
    </tr>`;
  });
}

// –≥–æ–ª–æ—Å –ë–∞—è–Ω
function bayanSpeak(text) {
  if (!("speechSynthesis" in window)) return;
  const speakNow = () => {
    const v = speechSynthesis.getVoices();
    let voice = v.find(x => x.name.includes("Google UK English Female") || x.lang === "en-GB");
    if (!voice) voice = v[0];
    const u = new SpeechSynthesisUtterance(text);
    u.voice = voice;
    u.lang = "en-GB";
    u.rate = 0.9;
    u.pitch = 1.1;
    u.volume = 1;
    speechSynthesis.speak(u);
  };
  if (speechSynthesis.getVoices().length === 0) {
    speechSynthesis.onvoiceschanged = speakNow;
  } else {
    speakNow();
  }
}

// —á–∞—Ç
async function askBayan() {
  const i = document.getElementById("chatInput");
  const b = document.getElementById("chatBox");
  const q = i.value.trim();
  if (!q) {
    alert("Type your question first!");
    return;
  }

  if (!isTeacher && usedToday >= DAILY_LIMIT) {
    alert("‚ö†Ô∏è Daily limit reached.");
    return;
  }

  b.innerHTML += `<p><b>You:</b> ${q}</p>`;
  i.value = "";
  b.innerHTML += `<p><i>AI Bayan is thinking...</i></p>`;
  b.scrollTop = b.scrollHeight;

  try {
    const r = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: [{ role: "user", content: q }] })
    });
    const d = await r.json();
    const reply = d.reply || "Sorry, I can‚Äôt answer now.";
    b.innerHTML += `<p><b>AI Bayan:</b> ${reply}</p>`;
    bayanSpeak(reply);

    // +1 –∫ –ª–∏–º–∏—Ç—É –∏ +–∑–≤–µ–∑–¥–∞ –≤ —á–∞—Ç-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å)
    if (!isTeacher) {
      usedToday++;
      localStorage.setItem("usedToday", usedToday);
      updateCounter();

      const student = localStorage.getItem("currentStudent");
      if (student) {
        let chatStars = Number(localStorage.getItem(student + "_chatStars")) || 0;
        chatStars++;
        localStorage.setItem(student + "_chatStars", chatStars);
        updateTotalStarsBox();
      }
    }
  } catch (e) {
    b.innerHTML += `<p><b>AI Bayan:</b> ‚ùå Connection error.</p>`;
  }
}

function clearChat() {
  document.getElementById("chatBox").innerHTML = "";
}

updateCounter();
</script>

<!-- ‚úÖ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è service worker –¥–ª—è PWA -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("sw.js")
      .catch(err => console.log("SW registration failed:", err));
  });
}
</script>

</body>
</html>
