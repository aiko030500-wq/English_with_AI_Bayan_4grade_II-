<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Bayan Chat ‚Äî English with AI Bayan 4grade II</title>

<style>
/* ‚Äî‚Äî‚Äî‚Äî‚Äî –°—Ç–∏–ª–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è ‚Äî‚Äî‚Äî‚Äî‚Äî */
body {
  font-family: Verdana, sans-serif;
  background: linear-gradient(180deg,#fff6e5 0%,#f3e0b8 100%);
  margin: 0;
  color: #002b5c;
  text-align: center;
}
header {
  background: #003366;
  color: white;
  padding: 1rem;
  border-bottom: 5px solid gold;
}
#chatBox {
  max-width: 600px;
  margin: 20px auto;
  background: white;
  border: 2px solid gold;
  border-radius: 12px;
  padding: 10px;
  height: 340px;
  overflow-y: auto;
  text-align: left;
}
.msg { margin:6px 0; padding:8px 12px; border-radius:10px; line-height:1.3; }
.user { background:#e3f2fd; border-left:3px solid #1565c0; }
.ai { background:#fff8e1; border-left:3px solid gold; }
#userInput {
  width: 70%;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid #ccc;
}
.btn {
  background:#003366; color:white;
  border:none; padding:8px 14px;
  border-radius:10px; cursor:pointer;
  font-weight:bold;
}
.btn:hover { background:gold; color:#003366; }
</style>
</head>

<body>
<header>
  <h1>ü§ñ AI Bayan ‚Äî Chat</h1>
  <p>English with <b style="color:gold;">AI Bayan</b> ‚Äî 4grade II</p>
</header>

<main>
  <div id="chatBox">
    <div class="msg ai"><b>AI Bayan:</b> Hello! üåü I‚Äôm your English helper.<br>Ask me about grammar, translation, or homework!</div>
  </div>

  <section id="inputArea">
    <input id="userInput" type="text" placeholder="Type your message..." />
    <button class="btn" id="sendBtn">Ask AI Bayan</button>
    <button class="btn" onclick="clearChat()">Clear</button>
    <button class="btn" onclick="goMenu()">üè† Back to Menu</button>
  </section>
</main>

<!-- ‚Äî‚Äî‚Äî‚Äî‚Äî –°–∫—Ä–∏–ø—Ç, –≤—Å—Ç–∞–≤–ª—è–µ–º –ü–ï–†–ï–î </body> ‚Äî‚Äî‚Äî‚Äî‚Äî -->
<script>
const WORKER_URL = "https://shiny-tree-f78c.aiko030500.workers.dev";

const chatBox = document.getElementById("chatBox");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

function showMessage(role, text) {
  const msg = document.createElement("div");
  msg.className = "msg " + role;
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendMessage() {
  const message = userInput.value.trim();
  if (!message) return;

  showMessage("user", "üßí " + message);
  userInput.value = "";
  showMessage("ai", "‚è≥ AI Bayan is thinking...");

  try {
    let res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: "You are AI Bayan, a kind English tutor for Grade 4 students from Kazakhstan." },
          { role: "user", content: message }
        ]
      })
    });

    // –ï—Å–ª–∏ OpenAI –≤–µ—Ä–Ω—É–ª 429 ‚Äî –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
    if (res.status === 429) {
      showMessage("ai", "‚ö†Ô∏è Too many requests. Waiting 2 seconds...");
      await new Promise(r => setTimeout(r, 2000));
      res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [
            { role: "system", content: "You are AI Bayan, a kind English tutor for Grade 4 students from Kazakhstan." },
            { role: "user", content: message }
          ]
        })
      });
    }

    const data = await res.json();

    if (!res.ok) {
      showMessage("ai", "‚ö†Ô∏è Error: " + (data.error || res.status));
      return;
    }

    showMessage("ai", "ü§ñ " + (data.reply || "No response."));
  } catch (err) {
    showMessage("ai", "‚ùå Connection failed: " + err.message);
  }
}

sendBtn.addEventListener("click", sendMessage);
userInput.addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

function clearChat() {
  chatBox.innerHTML = `<div class="msg ai"><b>AI Bayan:</b> Hello again! üåü Ask me about grammar or translation.</div>`;
}
function goMenu() {
  window.location.href = "index.html";
}
<script>
<script>
let DAILY_LIMIT = 3;
let usedToday = Number(localStorage.getItem("usedToday")) || 0;
let lastDate = localStorage.getItem("lastDate");
const today = new Date().toDateString();
let isTeacher = localStorage.getItem("isTeacher") === "true"; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–ª—å —É—á–∏—Ç–µ–ª—è

if (lastDate !== today) {
  usedToday = 0;
  localStorage.setItem("lastDate", today);
  localStorage.setItem("usedToday", 0);
}

// === –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ ===
function updateCounter() {
  const counter = document.getElementById("limitCounter");
  if (!counter) return;
  if (isTeacher) {
    counter.innerHTML = "üë©‚Äçüè´ Teacher mode: unlimited questions";
  } else {
    const left = DAILY_LIMIT - usedToday;
    counter.innerHTML = `‚≠ê ${left} of ${DAILY_LIMIT} questions left today`;
  }
}

// === –í—Ö–æ–¥ —É—á–∏—Ç–µ–ª—è ===
function teacherLogin() {
  const pin = prompt("Enter teacher PIN:");
  if (pin === "9997") {
    isTeacher = true;
    localStorage.setItem("isTeacher", "true");
    alert("üë©‚Äçüè´ Teacher mode activated ‚Äî unlimited questions.");
  } else {
    alert("‚ùå Wrong PIN.");
  }
  updateCounter();
}

// === –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ===
async function askBayan() {
  if (!isTeacher && usedToday >= DAILY_LIMIT) {
    const chatBox = document.getElementById("chatBox");
    chatBox.innerHTML += `<div class="msg ai"><b>AI Bayan:</b> ‚ö†Ô∏è You‚Äôve used your ${DAILY_LIMIT} questions for today. Please come back tomorrow!</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    return;
  }

  const input = document.getElementById("userInput");
  const message = input.value.trim();
  if (!message) return;

  const chatBox = document.getElementById("chatBox");
  chatBox.innerHTML += `<div class="msg user">${message}</div>`;
  input.value = "";
  chatBox.innerHTML += `<div class="msg ai">‚è≥ AI Bayan is thinking...</div>`;
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const response = await fetch("https://shiny-tree-f78c.aiko030500.workers.dev", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: "You are AI Bayan, a friendly English tutor for 4th-grade students." },
          { role: "user", content: message }
        ]
      })
    });

    const data = await response.json();
    const reply = data.reply || "‚ö†Ô∏è No reply received from AI Bayan.";
    chatBox.lastElementChild.innerHTML = `<b>AI Bayan:</b> ${reply}`;

    if (!isTeacher) {
      usedToday++;
      localStorage.setItem("usedToday", usedToday);
      updateCounter();
    }

  } catch (err) {
    chatBox.lastElementChild.innerHTML = `<b>AI Bayan:</b> ‚ùå Network error.`;
  }
}

updateCounter();
</script>
</body>
</html>
