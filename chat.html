<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Bayan Chat â€” English with AI Bayan 4grade II</title>

<style>
/* â€”â€”â€”â€”â€” Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ñ â€”â€”â€”â€”â€” */
body {
  font-family: Verdana, sans-serif;
  background: linear-gradient(180deg,#fff6e5 0%,#f3e0b8 100%);
  margin: 0;
  color: #002b5c;
  text-align: center;
}
header {
  background: #003366;
  color: white;
  padding: 1rem;
  border-bottom: 5px solid gold;
}
#chatBox {
  max-width: 600px;
  margin: 20px auto;
  background: white;
  border: 2px solid gold;
  border-radius: 12px;
  padding: 10px;
  height: 340px;
  overflow-y: auto;
  text-align: left;
}
.msg { margin:6px 0; padding:8px 12px; border-radius:10px; line-height:1.3; }
.user { background:#e3f2fd; border-left:3px solid #1565c0; }
.ai { background:#fff8e1; border-left:3px solid gold; }
#userInput {
  width: 70%;
  padding: 8px;
  border-radius: 10px;
  border: 1px solid #ccc;
}
.btn {
  background:#003366; color:white;
  border:none; padding:8px 14px;
  border-radius:10px; cursor:pointer;
  font-weight:bold;
}
.btn:hover { background:gold; color:#003366; }
</style>
</head>

<body>
<header>
  <h1>ğŸ¤– AI Bayan â€” Chat</h1>
  <p>English with <b style="color:gold;">AI Bayan</b> â€” 4grade II</p>
</header>

<main>
  <div id="chatBox">
    <div class="msg ai"><b>AI Bayan:</b> Hello! ğŸŒŸ Iâ€™m your English helper.<br>Ask me about grammar, translation, or homework!</div>
  </div>

  <section id="inputArea">
    <input id="userInput" type="text" placeholder="Type your message..." />
    <button class="btn" id="sendBtn">Ask AI Bayan</button>
    <button class="btn" onclick="clearChat()">Clear</button>
    <button class="btn" onclick="goMenu()">ğŸ  Back to Menu</button>
  </section>
</main>

<!-- â€”â€”â€”â€”â€” Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚, Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞŸĞ•Ğ Ğ•Ğ” </body> â€”â€”â€”â€”â€” -->
<script>
const WORKER_URL = "https://shiny-tree-f78c.aiko030500.workers.dev";

const chatBox = document.getElementById("chatBox");
const userInput = document.getElementById("userInput");
const sendBtn = document.getElementById("sendBtn");

function showMessage(role, text) {
  const msg = document.createElement("div");
  msg.className = "msg " + role;
  msg.textContent = text;
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function sendMessage() {
  const message = userInput.value.trim();
  if (!message) return;

  showMessage("user", "ğŸ§’ " + message);
  userInput.value = "";
  showMessage("ai", "â³ AI Bayan is thinking...");

  try {
    let res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: "You are AI Bayan, a kind English tutor for Grade 4 students from Kazakhstan." },
          { role: "user", content: message }
        ]
      })
    });

    // Ğ•ÑĞ»Ğ¸ OpenAI Ğ²ĞµÑ€Ğ½ÑƒĞ» 429 â€” Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒ Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ
    if (res.status === 429) {
      showMessage("ai", "âš ï¸ Too many requests. Waiting 2 seconds...");
      await new Promise(r => setTimeout(r, 2000));
      res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          messages: [
            { role: "system", content: "You are AI Bayan, a kind English tutor for Grade 4 students from Kazakhstan." },
            { role: "user", content: message }
          ]
        })
      });
    }

    const data = await res.json();

    if (!res.ok) {
      showMessage("ai", "âš ï¸ Error: " + (data.error || res.status));
      return;
    }

    showMessage("ai", "ğŸ¤– " + (data.reply || "No response."));
  } catch (err) {
    showMessage("ai", "âŒ Connection failed: " + err.message);
  }
}

sendBtn.addEventListener("click", sendMessage);
userInput.addEventListener("keydown", e => {
  if (e.key === "Enter") sendMessage();
});

function clearChat() {
  chatBox.innerHTML = `<div class="msg ai"><b>AI Bayan:</b> Hello again! ğŸŒŸ Ask me about grammar or translation.</div>`;
}
function goMenu() {
  window.location.href = "index.html";
}
// === Daily Request Limit & Teacher Mode ===
const DAILY_LIMIT = 4;             // ğŸ’¡ 4 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ² Ğ´ĞµĞ½ÑŒ
const TEACHER_PIN = "9997";        // ğŸ‘©â€ğŸ« PIN ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»Ñ
let isTeacher = false;

// Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ´Ğ½Ñ
const USER_KEY = "ai_bayan_requests_" + new Date().toDateString();

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ°, ĞµÑĞ»Ğ¸ ĞµÑ‰Ñ‘ Ğ½ĞµÑ‚
if (!localStorage.getItem(USER_KEY)) {
  localStorage.setItem(USER_KEY, "0");
}

// Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¾ÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ
function remainingRequests() {
  return DAILY_LIMIT - parseInt(localStorage.getItem(USER_KEY) || "0");
}

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ĞµÑ€ĞµĞ´ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹
function canSendRequest() {
  if (isTeacher) return true; // ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»Ñ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½

  const count = parseInt(localStorage.getItem(USER_KEY) || "0");
  if (count >= DAILY_LIMIT) {
    alert("âš ï¸ You've reached your daily limit of 4 questions. Try again tomorrow!");
    return false;
  }
  localStorage.setItem(USER_KEY, count + 1);
  updateCounter();
  return true;
}

// ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞµ
function updateCounter() {
  const counter = document.getElementById("limitCounter");
  if (!counter) return;
  if (isTeacher) {
    counter.textContent = "ğŸ‘©â€ğŸ« Teacher mode â€” unlimited questions";
    counter.style.color = "green";
  } else {
    counter.textContent = `â­ ${remainingRequests()} of ${DAILY_LIMIT} questions left today`;
    counter.style.color = "#003366";
  }
}

// Ğ’Ñ…Ğ¾Ğ´ ÑƒÑ‡Ğ¸Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ PIN
function teacherLogin() {
  const pin = prompt("Enter teacher PIN:");
  if (pin === TEACHER_PIN) {
    isTeacher = true;
    alert("âœ… Teacher mode activated!");
    updateCounter();
  } else {
    alert("âŒ Wrong PIN");
  }
}

// ĞŸÑ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº
document.addEventListener("DOMContentLoaded", updateCounter);
</script>
</body>
</html>
